# Data Folder Guide

This folder contains source data, local derived artifacts, and manually curated lookup files used by this project.

## What is version-controlled

- `data/manually_cleaned/` is version-controlled and intended for curated/manual fixes.
- `data/README.md` and `data/.gitkeep` are version-controlled.
- Generated/downloaded runtime artifacts under `data/raw/`, `data/cache/`, `data/mappings/`, and `data/output/` are local-only.

## Runtime layout and sources

| Path | Purpose | Source |
| --- | --- | --- |
| `data/raw/medicaid/` | Raw Medicaid provider spending dataset input (`.parquet`/archive extracts). | HHS Open Data Medicaid Provider Spending dataset. |
| `data/raw/nppes/monthly/` | Monthly NPPES V2 dissemination archives + extracted CSVs used for bulk NPI preload. | CMS NPPES dissemination files (`NPI_Files.html`). |
| `data/raw/nppes/weekly/` | Weekly NPPES V2 dissemination archives + extracted CSVs used for bulk NPI preload. | CMS NPPES dissemination files (`NPI_Files.html`). |
| `data/raw/cpt/archives/` | CPT/HCPCS source archives downloaded by `download.sh` (auto-discovered or explicit `--cpt-zip-url`). | CMS PFS National Payment Amount File pages (PFREV releases). |
| `data/raw/cpt/cpt_hcpcs_fallback.csv` | Derived local fallback table for HCPCS/CPT lookup when API is missing codes. | Built by `download.sh` from extracted CPT/HCPCS local files. |
| `data/manually_cleaned/PFREV26AR_nonQP/` | Manual CSV/MD cleanups (headers, indicators, status mappings) copied into extracted CPT source tree during setup/download. | Project-maintained curation from CMS PFREV source files. |
| `data/cache/` | SQLite caches for resumable NPI/HCPCS API state (`ok/not_found/error`). | Generated by `build_datasets`. |
| `data/mappings/` | Final NPI and HCPCS mapping CSVs (for downstream joins/analysis). | Generated by `build_datasets`. |
| `data/output/` | Generated outputs (API response parquets, triage CSVs). | Generated by `build_datasets`. |
| `data/unresolved_identifiers.csv` | End-of-run unresolved identifiers report (`npi` + `hcpcs`). | Generated by `build_datasets`. |

## Notes on manual cleaned overlays

`download.sh` applies manual overlays from:

- `data/manually_cleaned/PFREV26AR_nonQP/csv`
- `data/manually_cleaned/PFREV26AR_nonQP/md`

into the extracted local CPT source tree under `data/raw/cpt/` before fallback CSV generation.

This keeps hand-curated mapping metadata in git while allowing raw extracted source data to remain local.

## Unresolved identifier triage (pattern-based)

For quick manual review of unresolved identifiers, `build_datasets` writes an additional set of pattern-based triage CSVs after generating `data/unresolved_identifiers.csv`.

This runs automatically at the end of `./build_datasets.sh`.

Default output directory: `data/output/triage/`.

Outputs (written under `data/output/triage/`):

- `data/output/triage/hcpcs_identifiers_with_inferred_types.csv`
- `data/output/triage/hcpcs_unmapped_rows.csv`
- `data/output/triage/hcpcs_unmapped_unique_counts.csv`
- `data/output/triage/hcpcs_unknown_unique_with_prefixes.csv`
- `data/output/triage/hcpcs_unknown_prefix2_counts.csv`
- `data/output/triage/hcpcs_concat_unique_counts.csv`
- `data/output/triage/npi_identifiers_with_inferred_types.csv`
- `data/output/triage/npi_unmapped_rows.csv`
- `data/output/triage/npi_unmapped_unique_counts.csv`

### HCPCS breakdown (example run)

On `data/unresolved_identifiers.csv` with `identifier_type == "hcpcs"` (N = 4,610), the inferred pattern families were:

| Inferred code type (by pattern) | Typical format / regex | Count | % | Notes |
| --- | --- | ---: | ---: | --- |
| CPT / HCPCS Level I (5-digit numeric) | `^\\d{5}$` | 2,169 | 47.05% | Standard 5-digit procedure codes (CPT / HCPCS L1). |
| HCPCS Level II (letter + 4 digits) | `^[A-Z]\\d{4}$` | 474 | 10.28% | Supply/drug/ambulance/etc. HCPCS L2 codes. |
| CDT dental | `^D\\d{4}$` | 449 | 9.74% | ADA CDT dental procedure codes. |
| CPT Category II | `^\\d{4}F$` | 358 | 7.77% | Quality/performance tracking (Cat II) codes. |
| 5-char alphanumeric (unknown) | `^[A-Z0-9]{5}$` | 310 | 6.72% | Looks like internal/local code or truncated ID; not standard CPT/HCPCS/CDT by pattern. |
| Revenue codes (UB-04) | `^\\d{4}$` | 272 | 5.90% | Facility revenue center codes (UB-04 style). |
| CPT 4-digit + letter suffix (non F/T/U) | `^\\d{4}[A-Z]$` | 124 | 2.69% | Suffix-style codes like `0001A` (not Cat II/III/PLA). |
| CPT PLA | `^\\d{4}U$` | 110 | 2.39% | Proprietary Laboratory Analyses codes. |
| CPT Category III | `^\\d{4}T$` | 96 | 2.08% | Temporary/technology (Cat III) codes. |
| Word/flag token (non-code) | `^[A-Z]{3,}$` | 78 | 1.69% | All-caps flags like `LTFUP`, `VOID`, etc. |
| Other/unknown pattern | (varies) | 57 | 1.24% | Does not match any patterns above; inspect examples. |
| HCPCS L2 + modifier concatenated | `^([A-Z]\\d{4})([A-Z0-9]{2})$` | 39 | 0.85% | HCPCS Level II with a 2-char modifier stuck on (e.g., `Q3014GT`). |
| CPT 5-digit + modifier concatenated | `^(\\d{5})([A-Z0-9]{2})$` | 24 | 0.52% | CPT with a 2-char modifier stuck on (e.g., `99213GT`). |
| DRG-like (3-digit) | `^\\d{3}$` | 15 | 0.33% | Three-digit codes resembling DRG/MS-DRG numbers (needs context). |
| ICD-10-PCS-like | `^[0-9A-HJ-NP-Z]{7}$` | 11 | 0.24% | Seven-character ICD-10-PCS procedure code format. |
| 6-8 digit numeric (unknown) | `^\\d{6,8}$` | 7 | 0.15% | Numeric IDs that do not match typical claim code lengths; likely internal IDs. |
| Modifiers (2-char) | `^[A-Z0-9]{2}$` | 7 | 0.15% | Standalone line-item modifiers (e.g., `25`, `GT`, `QW`, `U3`). |
| Placeholder/invalid | (set) | 6 | 0.13% | Missing/placeholder values like `0`, `NULL`, `NA`, etc. |
| CDT + suffix concatenated | `^(D\\d{4})([A-Z0-9]{1,2})$` | 4 | 0.09% | CDT with an extra suffix appended (usually should be split/cleaned). |

The "needs review" buckets are:

- `alphanum_5char_unknown`
- `word_or_flag`
- `placeholder_or_invalid`
- `numeric_6to8_unknown`
- `unknown`

Together: 458 rows (9.93% of `hcpcs` unresolved).

### NPI format checker (example run)

On `data/unresolved_identifiers.csv` with `identifier_type == "npi"` (N = 24,271), this triage tool checks basic formatting and the NPI check digit (Luhn with the NPI prefix).

| Inferred type | Count | % | Notes |
| --- | ---: | ---: | --- |
| `npi_luhn_valid` | 20,160 | 83.06% | Looks like a well-formed NPI (10 digits + valid check digit). |
| `non_numeric` | 2,928 | 12.06% | Contains non-digits (often needs cleaning upstream). |
| `numeric_wrong_len` | 971 | 4.00% | All digits but not 10 digits long. |
| `npi_luhn_invalid` | 205 | 0.84% | 10 digits, but the check digit does not validate. |
| `placeholder_or_invalid` | 7 | 0.03% | Placeholder-like values (e.g., all zeros). |

"Needs review" for NPI is everything except `npi_luhn_valid`: 4,111 rows (16.94% of `npi` unresolved).
